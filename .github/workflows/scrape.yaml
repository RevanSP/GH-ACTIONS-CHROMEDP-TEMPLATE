name: Scrape Latest Data (Go + chromedp)

on:
  workflow_dispatch:
  schedule:
    - cron: '30 23 * * *' # 23:30 UTC = 06:30 WIB

jobs:
  scrape:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      TZ: 'Asia/Jakarta'
      CHROME_BIN: /usr/bin/google-chrome

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§  Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: ğŸ§° Install Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: ğŸ“¦ Generate go.sum
        run: |
          go mod download
          go mod tidy

      - name: ğŸ•¸ï¸ Run scraper
        run: |
          echo "â° Current time:"
          date
          echo "ğŸŒ Timezone: $TZ"
          echo "ğŸ“… Schedule: 30 23 * * * (23:30 UTC = 06:30 WIB)"
          echo "ğŸ” Event type: ${{ github.event_name }}"
          echo "ğŸ“Š Workflow run ID: ${{ github.run_id }}"
          echo "ğŸ“‹ Repository: ${{ github.repository }}"
          echo "ğŸŒ Next scheduled run: Tomorrow at 06:30 WIB"
          go run main.go

      - name: ğŸ’¾ Commit and push if data changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'chore: auto-scrape new data (Go chromedp)'
          file_pattern: 'public/data.json'
          commit_user_name: 'GitHub Actions'
          commit_user_email: 'actions@github.com'
          commit_author: 'github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>'

      - name: ğŸ¯ Manual Trigger Test
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "ğŸ¯ Manual trigger berhasil!"
          echo "â° Waktu: $(date)"
          echo "ğŸ“… Schedule akan aktif besok jam 06:30 WIB"